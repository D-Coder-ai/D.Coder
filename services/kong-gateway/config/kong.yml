# Kong Gateway Declarative Configuration
# Auto-generated from modular configuration files
# DO NOT EDIT THIS FILE DIRECTLY - Edit source files and rebuild
# Build: 2025-10-27 20:54:47 UTC
# Build script: scripts/build-kong-config.sh

_format_version: "3.0"

services:
# Agent Orchestrator Service Definition
# Platform service for durable workflow execution and agent orchestration
# Internal service: http://agent-orchestrator:8083

  - name: agent-orchestrator
  url: http://agent-orchestrator:8083
  protocol: http
  connect_timeout: 60000
  write_timeout: 60000
  read_timeout: 60000
  retries: 3
  tags:
    - r1
    - platform-service
    - agent-orchestrator
# Integrations Service Definition
# Platform service for external tool integrations (JIRA, Bitbucket, etc.)
# Internal service: http://integrations:8085

  - name: integrations
  url: http://integrations:8085
  protocol: http
  connect_timeout: 60000
  write_timeout: 90000  # External API calls may take time
  read_timeout: 90000
  retries: 3
  tags:
    - r1
    - platform-service
    - integrations
# Knowledge & RAG Service Definition
# Platform service for document processing and semantic search
# Internal service: http://knowledge-rag:8084

  - name: knowledge-rag
  url: http://knowledge-rag:8084
  protocol: http
  connect_timeout: 60000
  write_timeout: 120000  # RAG operations may take longer
  read_timeout: 120000
  retries: 3
  tags:
    - r1
    - platform-service
    - knowledge-rag
# LLMOps Platform Service Definition
# Platform service for prompt engineering and experimentation (Agenta)
# Internal service: http://llmops:8081

  - name: llmops
  url: http://llmops:8081
  protocol: http
  connect_timeout: 60000
  write_timeout: 60000
  read_timeout: 60000
  retries: 3
  tags:
    - r1
    - platform-service
    - llmops

routes:
- name: agent-workflows
  service: agent-orchestrator
  paths:
    - /v1/workflows
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - agent-route
    - workflows

- name: agent-orchestrator-api
  service: agent-orchestrator
  paths:
    - /v1/agents
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - agent-route
    - agents

- name: agent-executions
  service: agent-orchestrator
  paths:
    - /v1/executions
  methods:
    - GET
    - POST
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - agent-route
    - executions
- name: integrations-api
  service: integrations
  paths:
    - /v1/integrations
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - integration-route
    - integrations

- name: integrations-jira
  service: integrations
  paths:
    - /v1/integrations/jira
  methods:
    - GET
    - POST
    - PUT
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - integration-route
    - jira

- name: integrations-bitbucket
  service: integrations
  paths:
    - /v1/integrations/bitbucket
  methods:
    - GET
    - POST
    - PUT
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - integration-route
    - bitbucket

- name: integrations-webhooks
  service: integrations
  paths:
    - /v1/integrations/webhooks
  methods:
    - POST
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - integration-route
    - webhooks
- name: llmops-experiments
  service: llmops
  paths:
    - /v1/llmops/experiments
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - llmops-route
    - experiments

- name: llmops-prompts
  service: llmops
  paths:
    - /v1/llmops/prompts
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - llmops-route
    - prompts

- name: llmops-evaluations
  service: llmops
  paths:
    - /v1/llmops/evaluations
  methods:
    - GET
    - POST
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - llmops-route
    - evaluations

- name: llmops-deployments
  service: llmops
  paths:
    - /v1/llmops/deployments
  methods:
    - GET
    - POST
    - PUT
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - llmops-route
    - deployments
- name: knowledge-documents
  service: knowledge-rag
  paths:
    - /v1/knowledge/documents
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - rag-route
    - knowledge

- name: knowledge-search
  service: knowledge-rag
  paths:
    - /v1/knowledge/search
  methods:
    - POST
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - rag-route
    - search

- name: rag-pipeline
  service: knowledge-rag
  paths:
    - /v1/rag
  methods:
    - POST
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - rag-route
    - rag-pipeline

- name: knowledge-collections
  service: knowledge-rag
  paths:
    - /v1/knowledge/collections
  methods:
    - GET
    - POST
    - PUT
    - DELETE
  strip_path: false
  preserve_host: false
  protocols:
    - http
    - https
  tags:
    - r1
    - rag-route
    - collections

plugins:
  # Correlation ID - Add unique request ID for distributed tracing
  - name: correlation-id
    config:
      header_name: X-Request-Id
      generator: uuid
      echo_downstream: true

  # Prometheus - Expose metrics for monitoring
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  # Request ID - Ensure X-Request-Id propagation
  - name: request-id
    config:
      header_name: X-Request-Id
      echo_downstream: true
      generator: uuid

  # CORS - Allow cross-origin requests from client apps
  - name: cors
    config:
      origins:
        - "http://localhost:3000"   # Open WebUI Doc Chat
        - "http://localhost:3003"   # Open WebUI Code Chat
        - "http://localhost:3005"   # Admin Dashboard
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Request-Id
        - X-Tenant-Id
        - X-Platform-Id
        - X-User-Id
        - X-Trace-Id
        - Idempotency-Key
      exposed_headers:
        - X-Request-Id
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600
      preflight_continue: false

  - name: rate-limiting
    route: agent-workflows
    config:
      policy: redis
      redis:
        host: redis
        port: 6379
        database: 0
        timeout: 2000
        keepalive_pool_size: 30
        keepalive_backlog: 100
      limit_by: header
      header_name: X-Tenant-Id
      minute: 100
      hour: 5000
      day: 100000
      fault_tolerant: true
      hide_client_headers: false
      redis_ssl: false
      redis_ssl_verify: false

  - name: rate-limiting
    route: agent-orchestrator-api
    config:
      policy: redis
      redis:
        host: redis
        port: 6379
        database: 0
        timeout: 2000
      limit_by: header
      header_name: X-Tenant-Id
      minute: 100
      hour: 5000
      day: 100000
      fault_tolerant: true
      hide_client_headers: false

  - name: rate-limiting
    route: knowledge-search
    config:
      policy: redis
      redis:
        host: redis
        port: 6379
        database: 0
        timeout: 2000
      limit_by: header
      header_name: X-Tenant-Id
      minute: 50  # Lower limit for expensive search operations
      hour: 2500
      day: 50000
      fault_tolerant: true
      hide_client_headers: false

  - name: rate-limiting
    route: rag-pipeline
    config:
      policy: redis
      redis:
        host: redis
        port: 6379
        database: 0
        timeout: 2000
      limit_by: header
      header_name: X-Tenant-Id
      minute: 50  # Lower limit for expensive RAG operations
      hour: 2500
      day: 50000
      fault_tolerant: true
      hide_client_headers: false

  - name: rate-limiting
    route: integrations-api
    config:
      policy: redis
      redis:
        host: redis
        port: 6379
        database: 0
        timeout: 2000
      limit_by: header
      header_name: X-Tenant-Id
      minute: 100
      hour: 5000
      day: 100000
      fault_tolerant: true
      hide_client_headers: false

  - name: rate-limiting
    route: llmops-experiments
    config:
      policy: redis
      redis:
        host: redis
        port: 6379
        database: 0
        timeout: 2000
      limit_by: header
      header_name: X-Tenant-Id
      minute: 100
      hour: 5000
      day: 100000
      fault_tolerant: true
      hide_client_headers: false
  # JWT validation for agent orchestrator routes
  - name: jwt
    route: agent-workflows
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt_token
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      maximum_expiration: 86400  # 24 hours
      anonymous: null  # No anonymous access

  - name: jwt
    route: agent-orchestrator-api
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt_token
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      maximum_expiration: 86400

  - name: jwt
    route: knowledge-documents
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt_token
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      maximum_expiration: 86400

  - name: jwt
    route: knowledge-search
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt_token
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      maximum_expiration: 86400

  - name: jwt
    route: integrations-api
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt_token
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      maximum_expiration: 86400

  - name: jwt
    route: llmops-experiments
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt_token
      claims_to_verify:
        - exp
        - nbf
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      maximum_expiration: 86400
  # Global request transformer for all platform services
  - name: request-transformer
    config:
      add:
        headers:
          # Preserve X-Request-Id from correlation-id plugin
          - "X-Request-Id:$(headers.x-request-id)"
          # Add X-Trace-Id for distributed tracing
          - "X-Trace-Id:$(headers.x-request-id)"
          # Propagate tenant context
          - "X-Tenant-Id:$(headers.x-tenant-id)"
          - "X-Platform-Id:$(headers.x-platform-id)"
          - "X-User-Id:$(headers.x-user-id)"
          # Add Kong gateway identifier
          - "X-Gateway:kong"
          - "X-Gateway-Version:3.0"
      remove:
        headers:
          # Remove sensitive headers before forwarding
          - Authorization  # Will be re-added by service-specific auth
          - Cookie
      replace:
        headers: []
      rename:
        headers: []
      append:
        headers: []

# Custom Plugins
# quota-mirror plugin configuration
plugins:
  - name: quota-mirror
    enabled: true
    config:
      redis_host: redis
      redis_port: 6379
      redis_database: 0
      quota_key_prefix: "quota:tenant:"
      alert_threshold_percentage: 80.0
      enable_alerts: true
      block_on_quota_exceeded: false
      log_quota_checks: true
